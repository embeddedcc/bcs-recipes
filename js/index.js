/*! bcs-recipe-editor - v0.1.0 - 2014-04-08 */function newSetupField(){var a=$("#setup .fields fieldset").last().clone(!0),b=a.find("div.form-group");return b.attr("data-id",parseInt(b.attr("data-id"))+1),a.find("[data-name]").val(""),a.find("[data-name=targetState]").empty(),a.find("[data-name=targetElement]").empty(),$("#setup .fields fieldset").last().after(a),a}function populateStateOptions(a,b){a.empty(),a.append(new Option("")),$.each(bcs.processes[b].states,function(b,c){a.append(new Option(c.name,b))})}function populateElementOptions(a,b,c){var d=bcs.processes[b.val()];a.empty(),a.append(new Option("")),$.each(d.states[c].output_controllers,function(b,c){(3===c.mode||4===c.mode)&&a.append(new Option(bcs.outputs[b].name,"oc-"+b))}),$.each(d.states[c].exit_conditions,function(b,c){var e;c.enabled&&(2===c.source_type?(e=d.timers[c.source_number].name,a.append(new Option("Exit Condition "+(b+1)+": "+e,"ec-"+b))):a.append(new Option("Exit Condition "+(b+1),"ec-"+b)))})}function getTimers(a,b){bcs.processes[a].timers=[],async.times(4,function(b,c){$.get(bcs.url+"/api/process/"+a+"/timer/"+b,function(d){bcs.processes[a].timers[b]={},bcs.processes[a].timers[b].name=d.name,c()})},b)}function getStates(a,b){async.times(8,function(b,c){$.get(bcs.url+"/api/process/"+a+"/state/"+b,function(d){bcs.processes[a].states[b]={},bcs.processes[a].states[b].name=d.name,async.parallel([function(c){$.get(bcs.url+"/api/process/"+a+"/state/"+b+"/exit_conditions",function(d){bcs.processes[a].states[b].exit_conditions=d,c()})},function(c){$.get(bcs.url+"/api/process/"+a+"/state/"+b+"/output_controllers",function(d){bcs.processes[a].states[b].output_controllers=d,c()})}],c)})},b)}function initializeSetupPage(){var a,b=$("#setup [data-name=targetProcess]");b.empty(),b.append(new Option("")),$.each(bcs.processes,function(a,c){b.append(new Option(c.name,a))}),$("#setup [data-name=targetProcess]").on("change",function(a){var b=$(a.target).siblings("[data-name=targetState]"),c=a.target.value;populateStateOptions(b,c),$(a.target).siblings("[data-name=targetElement]").empty()}),$("#setup [data-name=targetState]").on("change",function(a){var b=$(a.target).siblings("[data-name=targetElement]"),c=$(a.target).siblings("[data-name=targetProcess]");populateElementOptions(b,c,a.target.value)}),localStorage["bcs-recipe.fields"]&&(a=JSON.parse(localStorage["bcs-recipe.fields"]),$.each(a,function(a,b){var c;c=a>0?newSetupField():$("#setup .fields fieldset").first(),c.find("[data-name=variable]").val(b.name),c.find("[data-name=targetProcess]").val(b.process),populateStateOptions(c.find("[data-name=targetState]"),b.process),c.find("[data-name=targetState]").val(b.state),populateElementOptions(c.find("[data-name=targetElement]"),c.find("[data-name=targetProcess]"),b.state),c.find("[data-name=targetElement]").val(b.element)}))}function api(a){var b="oc"===a.element.split("-")[0]?"/output_controllers":"/exit_conditions";return"/api/process/"+a.process+"/state/"+a.state+b}var bcslib={};bcslib.Time=function(){var a=function(a){return this.value=a||0,this},b=function(a){return 10>a?"0"+a:""+a};return a.prototype.toString=function(){var a=Math.floor(this.value/3600),c=Math.floor(this.value%3600/60),d=Math.floor(this.value%60);return a+":"+b(c)+":"+b(d)},a.prototype.fromString=function(a){var b=a.split(":").reverse();this.value=0;for(var c=0;c<b.length;c++){if(c>2)return this;this.value+=parseInt(b[c])*Math.pow(60,c)}return this},a}();var bcs={version:"",processes:[],outputs:[],get outputCount(){return"BCS-460"===this.version?6:8}};$(document).ready(function(){$("[data-name=bcs]").on("change",function(a){$.get(a.target.value+"/api/device",function(b){"4.0.0"===b.version?(bcs.version=b.type,bcs.url=a.target.value,localStorage["bcs-backup.url"]=bcs.url,$(a.target).parent().addClass("has-success").removeClass("has-error")):$(a.target).parent().addClass("has-error").removeClass("has-success"),$(".loading").removeClass("hide"),$(".fields").addClass("hide"),async.series([function(a){async.times(8,function(a,b){$.get(bcs.url+"/api/process/"+a,function(c){bcs.processes[a]={},bcs.processes[a].name=c.name,bcs.processes[a].states=[],async.series([function(b){getTimers(a,b)},function(b){getStates(a,b)}],b)}).fail(function(){$(".failed").removeClass("hide"),$(".loading").addClass("hide"),$(".fields").addClass("hide"),b(!0)})},a)},function(a){async.times(bcs.outputCount,function(a,b){$.get(bcs.url+"/api/output/"+a,function(c){bcs.outputs[a]=c,b()})},a)}],function(){if($(a.target).parents("#setup").length)initializeSetupPage();else if(localStorage["bcs-recipe.fields"]){var b=JSON.parse(localStorage["bcs-recipe.fields"]);$.each(b,function(a,b){var c=$("#values fieldset.template").clone(),d=c.find("input");c.removeClass("hide"),c.removeClass("template"),c.find("label").html(b.name),d.attr("data-api",api(b)),d.attr("data-key",b.element.split("-")[1]),d.attr("data-type","oc"===b.element.split("-")[0]?"number":"time"),d.attr("data-attr","oc"===b.element.split("-")[0]?"setpoint":"value"),$.get(bcs.url+api(b),function(a){var b="number"===d.attr("data-type")?a[d.attr("data-key")].setpoint/10:new bcslib.Time(a[d.attr("data-key")].value/10).toString();d.val(b)}),d.on("change",function(){var a={key:parseInt(d.attr("data-key")),value:{}};"number"===d.attr("data-type")?a.value[d.attr("data-attr")]=10*parseInt(d.val()):"time"===d.attr("data-type")&&(a.value[d.attr("data-attr")]=10*(new bcslib.Time).fromString(d.val()).value),$.post(bcs.url+d.attr("data-api"),JSON.stringify(a),function(a){var b="number"===d.attr("data-type")?a[d.attr("data-key")].setpoint/10:new bcslib.Time(a[d.attr("data-key")].value/10).toString();d.val(b)})}),$("#values .fields").append(c)})}$(".loading").addClass("hide"),$(".fields").removeClass("hide")})}).fail(function(){$(a.target).parent().addClass("has-error").removeClass("has-success")})}),$("#setup button").on("click",function(){event.preventDefault();var a=[];$("#setup .fields div.form-group").each(function(b,c){var d=$(c),e={name:d.find("[data-name=variable]").val(),process:d.find("[data-name=targetProcess]").val(),state:d.find("[data-name=targetState]").val(),element:d.find("[data-name=targetElement]").val()};a.push(e)}),localStorage["bcs-recipe.fields"]=JSON.stringify(a)}),$("#setup a.new").on("click",newSetupField),$("#setup a.remove").on("click",function(a){a.preventDefault();var b=$(a.target).parents("fieldset");"0"!==b.find("div.form-group").attr("data-id")?b.remove():b.find("[data-name]").val("")}),localStorage["bcs-backup.url"]&&($("[data-name=bcs]").val(localStorage["bcs-backup.url"]),$("[data-name=bcs]").change())});